<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Plateforme 3D avec Personnage</title>
    <style>
        /* --- Styles Généraux --- */
        body {
            margin: 0;
            height: 100vh;
            /* Empêche le défilement de la page quand on touche le joystick */
            overflow: hidden; 
            background-color: #222;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Mode "Horizontal" (Landscape) */
            flex-direction: row; 
        }

        /* --- Styles de la Scène 3D (comme avant) --- */
        .scene {
            width: 400px; /* Plus grand */
            height: 400px;
            border: 1px dashed #999;
            perspective: 1000px;
            transform-style: preserve-3d;
            /* Angle de vue pour bien voir le plan X-Z */
            transform: rotateX(-30deg) rotateY(30deg);
        }

        .platform {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 150, 255, 0.7);
            border: 2px solid #0056b3;
            box-sizing: border-box;
            
            /* Met la plateforme à plat sur l'axe X-Z */
            transform: rotateX(90deg);
            
            /* ESSENTIEL : pour que le personnage soit positionné PAR RAPPORT à la plateforme */
            position: relative; 
        }

        /* --- NOUVEAU : Le Personnage --- */
        .character {
            width: 30px;
            height: 30px;
            background-color: #ff4500;
            border: 2px solid #b33000;
            border-radius: 50%; /* Une simple sphère */
            
            /* Positionné par rapport au coin haut-gauche de la plateforme */
            position: absolute;
            
            /* Point de départ (50% - 15px pour le centrer) */
            left: calc(50% - 15px);
            top: calc(50% - 15px); /* Note : 'top' agira comme notre axe Z */

            /* Correction pour que la "sphère" ait l'air posée dessus */
            transform: translateY(-15px); /* La "soulève" de moitié */
        }

        /* --- NOUVEAU : Le Joystick Virtuel --- */
        #joystick-container {
            width: 150px;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            position: fixed; /* Reste fixe à l'écran */
            bottom: 30px;
            left: 30px;
            display: grid;
            place-items: center;
            user-select: none; /* Empêche de sélectionner le texte */
        }

        #joystick-thumb {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            /* Transition douce quand on le relâche */
            transition: transform 0.1s ease-out; 
            transform: translate(0px, 0px);
        }

    </style>
</head>
<body>

    <div class="scene">
        <div class="platform">
            <div class="character" id="player"></div>
        </div>
    </div>

    <div id="joystick-container">
        <div id="joystick-thumb"></div>
    </div>

    <script>
        // --- Références aux éléments ---
        const player = document.getElementById('player');
        const joystick = document.getElementById('joystick-container');
        const thumb = document.getElementById('joystick-thumb');

        // --- État du personnage ---
        // Position en % (0 à 100) pour rester simple
        let playerX = 50; 
        let playerZ = 50; // On utilise 'playerZ' pour la variable 'top'
        const playerSpeed = 1.0; // Vitesse de déplacement

        // --- État du Joystick ---
        let isDragging = false;
        let joystickOriginX = 0;
        let joystickOriginY = 0;
        let moveX = 0; // Direction X (-1 à 1)
        let moveZ = 0; // Direction Z (-1 à 1)
        const joystickRadius = joystick.offsetWidth / 2;

        // --- Fonctions de Démarrage (Souris ou Doigt) ---
        function startDrag(event) {
            isDragging = true;
            // Empêche le défilement sur mobile
            event.preventDefault(); 
            
            // On récupère la position du clic/doigt
            const touch = event.changedTouches ? event.changedTouches[0] : event;
            joystickOriginX = touch.clientX;
            joystickOriginY = touch.clientY;
        }

        // --- Fonctions de Fin (Souris ou Doigt) ---
        function stopDrag() {
            if (!isDragging) return;
            isDragging = false;
            moveX = 0;
            moveZ = 0;
            // Ramène le joystick au centre
            thumb.style.transform = 'translate(0px, 0px)'; 
        }

        // --- Fonction de Mouvement (Souris ou Doigt) ---
        function moveDrag(event) {
            if (!isDragging) return;
            event.preventDefault();
            
            const touch = event.changedTouches ? event.changedTouches[0] : event;
            
            // Calcule le delta (différence) depuis l'origine
            let deltaX = touch.clientX - joystickOriginX;
            let deltaY = touch.clientY - joystickOriginY;

            // Limite le mouvement au rayon du joystick (Pythagore)
            const distance = Math.min(joystickRadius, Math.hypot(deltaX, deltaY));
            const angle = Math.atan2(deltaY, deltaX);

            // Recalcule X et Y en fonction de la distance limitée
            deltaX = distance * Math.cos(angle);
            deltaY = distance * Math.sin(angle);

            // Met à jour la position visuelle du joystick
            thumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

            // Convertit le delta en direction normalisée (-1 à 1)
            moveX = deltaX / joystickRadius;
            moveZ = deltaY / joystickRadius; // 'Y' du joystick contrôle 'Z' du perso
        }

        // --- La "Boucle de Jeu" (Game Loop) ---
        function gameLoop() {
            if (isDragging) {
                // Met à jour la position du joueur
                // On ajoute des limites pour qu'il ne tombe pas (0% à 100% - taille)
                playerX += moveX * playerSpeed;
                playerZ += moveZ * playerSpeed;

                // Limites (0 à 93% pour un perso de ~7% de large/haut)
                playerX = Math.max(0, Math.min(93, playerX));
                playerZ = Math.max(0, Math.min(93, playerZ));

                // Applique la position au CSS
                // 'left' contrôle l'axe X
                player.style.left = playerX + '%';
                // 'top' contrôle l'axe Z (car la plateforme est tournée)
                player.style.top = playerZ + '%';
            }
            
            // Demande au navigateur de rappeler cette fonction
            // dès qu'il est prêt à dessiner la prochaine image
            requestAnimationFrame(gameLoop);
        }

        // --- Attacher les écouteurs d'événements ---
        
        // Pour Mobile (doigt)
        joystick.addEventListener('touchstart', startDrag);
        document.addEventListener('touchend', stopDrag);
        document.addEventListener('touchmove', moveDrag);

        // Pour Ordinateur (souris)
        joystick.addEventListener('mousedown', startDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('mousemove', moveDrag);

        // --- Démarrer la boucle de jeu ---
        gameLoop();

    </script>
</body>
</html>
