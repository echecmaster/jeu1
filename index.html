<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jeu 3D - Rotation de Caméra</title>
    <style>
        /* --- Styles Généraux --- */
        body {
            margin: 0;
            height: 100vh;
            overflow: hidden; 
            background-color: #111;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: row; 
        }

        /* --- 1. Conteneur principal de la Scène --- */
        #game-container {
            width: 80vw; 
            height: 70vh;
            perspective: 1200px; /* Profondeur de champ */
            overflow: hidden;
            /* La rotation de la caméra sera appliquée ici */
            transform-style: preserve-3d; 
            cursor: grab; /* Curseur de préhension pour la rotation */
        }
        #game-container:active {
            cursor: grabbing;
        }

        /* --- 2. Le Monde (Déplacé pour suivre le perso) --- */
        .scene {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            /* Le JS déplacera et inclinera la caméra ici */
            transform: translateZ(-500px) rotateX(-25deg); 
            transform-origin: center; 
        }

        /* --- Plateforme --- */
        .platform {
            width: 1000px;
            height: 1000px;
            background-color: #444;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 49px, #555 49px, #555 50px),
                repeating-linear-gradient(90deg, transparent, transparent 49px, #555 49px, #555 50px);
            background-size: 50px 50px;

            transform: rotateX(90deg);
            
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -500px; 
            margin-top: -500px; 
            position: relative; 
            z-index: 1; 
        }

        /* --- Personnage (Cylindre 3D) --- */
        .character {
            width: 25px;
            height: 40px;
            background-color: #ff4500;
            border: 2px solid #b33000;
            border-radius: 12.5px; 
            
            position: absolute;
            left: 50%; 
            top: 50%; 
            
            transform-style: preserve-3d;
            transform-origin: center center; 
            
            z-index: 10; 
        }

        /* Le "dessus" du cylindre (le chapeau) */
        .character::before {
            content: '';
            position: absolute;
            width: 100%; 
            height: 25px; 
            background-color: #ff7040; 
            border-radius: 50%;
            top: 0;
            left: 0;
            
            transform: rotateX(90deg) translateY(-12.5px);
        }


        /* --- Interface Joystick --- */
        #joystick-container {
            width: 120px; height: 120px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            position: fixed;
            bottom: 40px; left: 40px;
            display: grid; place-items: center;
            user-select: none;
        }

        #joystick-thumb {
            width: 40px; height: 40px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            transition: transform 0.1s ease-out; 
            transform: translate(0px, 0px);
        }

        /* --- Éléments supprimés de l'interface --- */
        /* #jump-button n'existe plus en HTML/JS */
    </style>
</head>
<body>

    <div id="game-container">
        <div class="scene">
            <div class="platform">
                <div class="character" id="player"></div>
            </div>
        </div>
    </div>

    <div id="joystick-container">
        <div id="joystick-thumb"></div>
    </div>


    <script>
        // --- Références aux éléments ---
        const player = document.getElementById('player');
        const joystick = document.getElementById('joystick-container');
        const gameContainer = document.getElementById('game-container'); // NOUVEAU
        const scene = document.querySelector('.scene'); // Le monde 3D
        const thumb = document.getElementById('joystick-thumb');

        // --- État du personnage ---
        let playerX = 50;
        let playerZ = 50;
        const playerSpeed = 0.5;

        // --- État de la Caméra (NOUVEAU) ---
        let cameraRotationY = -25; // Rotation initiale Y
        let cameraPitchX = -25; // Inclinaison initiale X (pour l'effet 3D)
        let isRotating = false;

        // --- Contrôles (Joystick) ---
        let isDragging = false;
        let moveX = 0;
        let moveZ = 0;
        const joystickRadius = joystick.offsetWidth / 2;
        
        // --- Variables de rotation ---
        let lastX = 0;
        let lastY = 0;
        const rotationSpeed = 0.3;

        // --- Suppression du Saut (Variables inutiles) ---
        // let playerY_pixels = 0;
        // let velocityY = 0;
        // let isJumping = false;
        // const gravity = -1;
        // const jumpStrength = 15;
        const playerBottomOnGroundOffset = 20; 


        // --- Fonctions Joystick ---
        function getTouch(event) {
            return event.changedTouches ? event.changedTouches[0] : event;
        }

        const dragData = { joystickOriginX: 0, joystickOriginY: 0 }; 

        function startDrag(event) {
            isDragging = true;
            event.preventDefault(); 
            const touch = getTouch(event);
            dragData.joystickOriginX = touch.clientX; 
            dragData.joystickOriginY = touch.clientY;
        }

        function stopDrag() {
            if (!isDragging) return;
            isDragging = false;
            moveX = 0;
            moveZ = 0;
            thumb.style.transform = 'translate(0px, 0px)'; 
        }

        function moveDrag(event) {
            if (!isDragging) return;
            event.preventDefault();
            const touch = getTouch(event);
            
            let deltaX = touch.clientX - dragData.joystickOriginX;
            let deltaY = touch.clientY - dragData.joystickOriginY;

            const distance = Math.min(joystickRadius, Math.hypot(deltaX, deltaY));
            const angle = Math.atan2(deltaY, deltaX);

            deltaX = distance * Math.cos(angle);
            deltaY = distance * Math.sin(angle);

            thumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

            moveX = deltaX / joystickRadius;
            moveZ = deltaY / joystickRadius;
        }
        
        // --- Fonctions de Rotation de Caméra (NOUVEAU) ---

        function startRotation(event) {
            // S'assure de ne pas commencer la rotation si on utilise le joystick
            if (event.target.id === 'joystick-container' || event.target.id === 'joystick-thumb') return; 
            
            isRotating = true;
            event.preventDefault(); 
            const touch = getTouch(event);
            lastX = touch.clientX;
            lastY = touch.clientY;
        }

        function stopRotation() {
            isRotating = false;
        }

        function moveRotation(event) {
            if (!isRotating) return;
            event.preventDefault();
            const touch = getTouch(event);
            
            const deltaX = touch.clientX - lastX;
            // Rotation Y (horizontal)
            cameraRotationY += deltaX * rotationSpeed;
            
            const deltaY = touch.clientY - lastY;
            // Inclinaison X (vertical, optionnel)
            cameraPitchX = Math.max(-80, Math.min(5, cameraPitchX + deltaY * rotationSpeed));

            lastX = touch.clientX;
            lastY = touch.clientY;
        }


        // --- La "Boucle de Jeu" ---
        function gameLoop() {
            
            // 1. Mouvement X-Z (Déplacement)
            if (moveX !== 0 || moveZ !== 0) {
                playerX += moveX * playerSpeed;
                playerZ += moveZ * playerSpeed;

                // Limites de la plateforme 
                playerX = Math.max(0, Math.min(97.5, playerX));
                playerZ = Math.max(0, Math.min(96, playerZ));
            }

            // 2. Appliquer les Transformations
            
            player.style.left = playerX + '%';
            player.style.top = playerZ + '%';
            
            /* L'axe Y (saut) est retiré, seule la correction de hauteur est appliquée */
            player.style.transform = `translateZ(${playerBottomOnGroundOffset}px)`;
            
            // Appliquer la rotation de la caméra au conteneur principal
            gameContainer.style.transform = `rotateY(${cameraRotationY}deg) rotateX(${cameraPitchX}deg)`;
            
            /* DÉCALAGE DE LA SCÈNE (Suivi du perso)
             * Le monde entier doit se décaler dans la direction opposée 
             * du personnage pour le garder au centre. 
             */
            const translateX = 500 - (playerX * 10); // Ajusté à 10 pour la map 1000px
            const translateZ = 500 - (playerZ * 10);

            scene.style.transform = `translateZ(-500px) 
                                     translateX(${translateX}px) 
                                     translateY(${translateZ}px) 
                                     rotateX(-25deg)`; // Garde l'inclinaison de la plateforme

            
            requestAnimationFrame(gameLoop);
        }

        // --- Attacher les écouteurs d'événements ---
        
        // Joystick
        joystick.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('touchend', stopDrag);
        document.addEventListener('touchmove', moveDrag, { passive: false });
        joystick.addEventListener('mousedown', startDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('mousemove', moveDrag);
        
        // Rotation de Caméra (attachée au document/conteneur)
        gameContainer.addEventListener('mousedown', startRotation, { passive: false });
        document.addEventListener('mouseup', stopRotation);
        document.addEventListener('mousemove', moveRotation, { passive: false });
        
        gameContainer.addEventListener('touchstart', startRotation, { passive: false });
        document.addEventListener('touchend', stopRotation);
        document.addEventListener('touchmove', moveRotation, { passive: false });

        // --- Démarrer la boucle de jeu ---
        gameLoop();

    </script>
</body>
</html>
